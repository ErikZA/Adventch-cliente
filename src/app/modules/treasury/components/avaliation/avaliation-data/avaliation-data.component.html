<mat-sidenav fxLayout="column" #sidenavRight mode="side" align="end" class="sidenav-right mat-elevation-z4" (keydown.esc)="closeSidenav()"
  [class.mat-drawer-opened]="sidenavRight.opened" [class.mat-drawer-closed]="!sidenavRight.opened">
  <button mat-icon-button type="button" matTooltip="Fechar" (click)="closeSidenav()">
    <mat-icon>clear</mat-icon>
  </button>
  <div>
    <router-outlet></router-outlet>
  </div>
</mat-sidenav>
<div class="page-container mat-elevation-z2" fxFlex fxLayoutAlign="center" style="overflow: auto;">
  <div fxFlex="95%">
    <div class="margin-top-small" fxLayout="row" fxLayoutAlign="space-between">
      <h2 class="title" *ngIf="!searchButton">Lista de Avaliações</h2>
      <mat-form-field *ngIf="searchButton" fxFlex>
        <input matInput placeholder="Pesquisar..." (keyup)="search$.next($event.target.value)" (blur)="search$.next($event.target.value)">
      </mat-form-field>
      <div class="buttons" fxLayoutAlign="start center">
        <button mat-icon-button (click)="searchButton = !searchButton">
          <mat-icon aria-label="Pesquisar Tesoureiro">search</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Filtragem avançada" (click)="expandPanel(matExpansionPanel)">
          <mat-icon aria-label="Filtragem avançada">filter_list</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Imprimir avaliações" (click)="generateGeneralReport()">
          <mat-icon aria-label="Imprimir relatório geral">print</mat-icon>
        </button>
      </div>
    </div>
    <mat-accordion class="example-headers-align" #matExpansionPanel>
      <mat-expansion-panel #matExpansionPanel hideToggle="true">
        <div fxLayout="row wrap" style="flex-wrap: wrap;">
          <mat-list flex="35" class="margin-search" style="padding: 0 8px;">
            <mat-form-field>
              <mat-select placeholder="Status" (change)="search()" [(ngModel)]="filterStatus">
                <mat-option [value]="0">TODOS</mat-option>
                <mat-option [value]="1">Aguardando</mat-option>
                <mat-option [value]="2">Avaliando</mat-option>
                <mat-option [value]="3">Finalizado</mat-option>
              </mat-select>
            </mat-form-field>
          </mat-list>
          <mat-list flex="35" class="margin-search" style="padding: 0 8px;">
            <mat-form-field>
              <mat-select placeholder="Distrito" (change)="search()" [(ngModel)]="filterDistrict">
                <mat-option [value]="0">TODOS</mat-option>
                <mat-option *ngFor="let district of districts" [value]="district.id">
                  {{ district.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </mat-list>
          <mat-list flex="35" class="margin-search" style="padding: 0 8px;">
            <mat-form-field>
              <mat-select placeholder="Analista" (change)="search()" [(ngModel)]="filterAnalyst">
                <mat-option [value]="0">TODOS</mat-option>
                <mat-option *ngFor="let analyst of analysts" [value]="analyst.id">
                  {{ analyst.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </mat-list>
          <mat-list flex="35" class="margin-search" style="padding: 0 8px;">
            <mat-form-field>
              <mat-select placeholder="Mês" (change)="search()" [(ngModel)]="filterMonth">
                <mat-option [value]="1">Janeiro</mat-option>
                <mat-option [value]="2">Fevereiro</mat-option>
                <mat-option [value]="3">Março</mat-option>
                <mat-option [value]="4">Abril</mat-option>
                <mat-option [value]="5">Maio</mat-option>
                <mat-option [value]="6">Junho</mat-option>
                <mat-option [value]="7">Julho</mat-option>
                <mat-option [value]="8">Agosto</mat-option>
                <mat-option [value]="9">Setembro</mat-option>
                <mat-option [value]="10">Outubro</mat-option>
                <mat-option [value]="11">Novembro</mat-option>
                <mat-option [value]="12">Dezembro</mat-option>
              </mat-select>
            </mat-form-field>
          </mat-list>
          <mat-list flex="35" class="margin-search" style="padding: 0 8px;">
            <mat-form-field>
              <mat-select placeholder="Ano" (change)="search()" [(ngModel)]="filterYear">
                <!-- <mat-option value="0">TODOS</mat-option> -->
                <mat-option *ngFor="let year of years" [value]="year">
                  {{ year }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </mat-list>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
    <mat-divider></mat-divider>
    <div>
      <div class="header">
        <mat-list>
          <mat-list-item>
            <h3 matLine fxLayout="row">
              <span fxFlex fxFlex.gt-sm="10%" style="text-align: center">Código</span>
              <span fxFlex fxFlex.gt-sm="29%">Igreja</span>
              <span fxFlex fxFlex.gt-sm="29%" fxHide.lt-sm>Distrito</span>
              <span fxFlex fxFlex.gt-sm="10%" fxHide.lt-sm style="text-align: center">Pontuação</span>
              <span fxFlex fxFlex.gt-sm="19%" fxHide.lt-sm>Status</span>
            </h3>
          </mat-list-item>
        </mat-list>
        <mat-divider></mat-divider>
      </div>
      <div class="conteiner" infiniteScroll [infiniteScrollDistance]="1" [infiniteScrollThrottle]="300" (scrolled)="onScroll()" [scrollWindow]="false">
        <mat-accordion>
          <div *ngFor="let avaliation of (avaliations$ | async ); index as i">
            <mat-expansion-panel hideToggle *ngIf="i <= showList">
              <mat-expansion-panel-header>
                <mat-panel-description fxLayout="row" fxFlex>
                  <span fxFlex fxFlex.gt-sm="10%" style="white-space: line-wrap;" style="text-align: center">
                    {{ avaliation.church.code }}
                  </span>
                  <span fxFlex fxFlex.gt-sm="30%" style="white-space: line-wrap">
                    {{ avaliation.church.name }}
                  </span>
                  <span fxFlex.gt-sm="30%" fxHide.lt-sm style="white-space: line-wrap">
                    {{ avaliation.church?.district.name }}
                  </span>
                  <span fxFlex.gt-sm="10%" fxHide.lt-sm style="white-space: line-wrap; text-align: center">
                    {{ avaliation.total }}
                  </span>
                  <span fxFlex.gt-sm="20%" fxHide.lt-sm>
                    <div style="white-space: line-wrap; text-align: center; color: white; font-size: 11px;  padding: 5px; width: 100px;" [ngStyle]="getStatusColor(avaliation)">{{ getStatusString(avaliation) }}</div>
                  </span>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <mat-list>
                <h3 matSubheader>Informações da avaliação</h3>
                <mat-list-item fxLayout="row" style="height: auto">
                  <div fxLayout="column" fxFlex matLine>
                    <span *ngIf="avaliation.church?.district" class="details-title" fxLayout.lt-sm="row" fxHide.gt-xs fxLayoutGap.lt-sm="10px">
                      <b>Distrito:&ensp;</b> {{ avaliation.church?.district.name }}
                    </span>
                    <span class="details-title" fxLayout.lt-sm="row" fxHide.gt-xs fxLayoutGap.lt-sm="10px">
                      <b>Pontuação:&ensp;</b> {{ avaliation.total }}
                    </span>
                    <span class="details-title" fxLayout.lt-sm="row" fxHide.gt-xs fxLayoutGap.lt-sm="10px">
                      <b>Status:&ensp;</b> <div style="white-space: line-wrap; text-align: center; color: white; font-size: 11px;  padding: 5px; width: 100px;" [ngStyle]="getStatusColor(avaliation)">{{ getStatusString(avaliation) }}</div>
                    </span>
                    <span class="details-title" fxLayout.lt-sm="column">
                      <b>Tesoureiro(s)</b>
                    </span>
                    <div *ngFor="let treasurer of avaliation.treasurers">
                      <mat-panel-description fxLayout="row" fxFlex>
                        <span *ngIf="treasurer" fxFlex="100%" class="details-title" style="white-space: normal; padding: 0 30px 0 30px">{{ treasurer.name }}</span>
                      </mat-panel-description>
                    </div>
                  </div>
                </mat-list-item>
              </mat-list>
              <mat-action-row>
                <ng-template [Feature]="52">
                  <button mat-button *ngIf="checkFinalized(avaliation, true)" style="background-color: #687A8F!important; color: #fff" matTooltip="Avaliação mensal"
                    (click)="mensal(avaliation)">AVALIAR</button>
                </ng-template>
                <ng-template [Feature]="53">
                  <button mat-button *ngIf="checkFinalized(avaliation, false)" style="background-color: #314762!important; color: #fff" matTooltip="Avaliação anual"
                    (click)="anual(avaliation)">ANUAL</button>
                </ng-template>
                <ng-template [Feature]="54">
                  <button mat-button style="background-color: #0D2139!important; color: #fff" matTooltip="Finalizar avaliação da igre" [matMenuTriggerFor]="menu">
                    <mat-icon>list</mat-icon>FINALIZAR</button>
                  <mat-menu #menu="matMenu">
                    <button *ngIf="checkChurchHasAvaliation(avaliation, true)" (click)="finalize(avaliation, true)" mat-menu-item matTooltip="Finaliza apenas a avaliação mensal da igreja">Mensal</button>
                    <button *ngIf="checkChurchHasAvaliation(avaliation, false)" (click)="finalize(avaliation, false)" mat-menu-item matTooltip="Finaliza apenas a avaliação anual da igreja">Anual</button>
                  </mat-menu>
                </ng-template>
              </mat-action-row>
            </mat-expansion-panel>
          </div>
        </mat-accordion>
      </div>
    </div>
  </div>
</div>
